package com.d2c.main.openapi.controller.home;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.d2c.common.api.json.JsonBean;
import com.d2c.common.base.utils.DateUt;
import com.d2c.common.base.utils.RandomUt;
import com.d2c.common.core.http.RestHelper;
import com.d2c.main.openapi.controller.base.BaseController;
import com.d2c.main.openapi.interceptor.TokenHandler;
import com.d2c.openapi.api.entity.OpenUserDO;

/**
 * OpenApi 用户商家
 * @author wull
 */
@RestController
@RequestMapping(value = "test")
public class OpenTestController extends BaseController {
	
	@Autowired
	private TokenHandler tokenHandler;
	
	private static final int NONCE_MAX = 100000;
	
	static final String privateKey = "MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAPSN4NibKam805FCnPpG5kRa8nT4QP0LBOZl_EvUrv3FZqyBi77aONraDzdDwFBY1jiJTfAHBxpdLbH-T5vzs4IAoSn44f9FXGlO9BfQjRzRjeRS6ehysMQKet1jrdwC9xbI2fXvZKhbsQOTFvEi8KlVrySW-gu2BtNu6fEjTygvAgMBAAECgYAa4xO6vNRyekrdyEUZ_ybckmM1w6rhfI9SsBkc_TUqvBlIaLXEi0QqS5nV_veV3dkvk2j44CJCc8bNBaNwXKAk49qFDDLDEf19Oo68-gdPdpNziJmkYSZ60kcW_siG8AY5qskYwPqYNXUESk1HOfL7T7BdSUF8UbKtNxPo_hKBAQJBAP9Cvjapoii9UtDCXOlwsmywAdgXW5Ww3dC2Zvz8YzAGyvMZDvMsx1I9Gi6BAmhPqrY4B9EvLwZAnQtrq4ZPmqcCQQD1QzJ71OhoNTDsz06VGWzuthyakUikhmPsxFKRiOhRnkgy4lDuRD-XGY7XXEYEKsGDMg5om3stD_ZfqdoaOJ85AkAU_VsAybAg43iE3Aah13eEgnCUYU9RnsqOmAEd-m75iwVzOfNFwb_eHlIh0s_s3egutarG47ddL0D6qG7hS3hvAkEA8I36-vflByh8lxfxlE2-yRc3UOcEX9IsOfKIpZOpgTwExluxUzD_Sd1Ye6RWTAn_iQVUmoc9NgJ8_HEkqSk2CQJAcpdnOTbQU41OCDOGXxWS0vtvf5yd89MG8IRB0xIeg13T43tYCqz6OaMwsBFNKoL87puDGVwF5Me2VoSnjO3KOg";
	static final String token = "52f77d34-205f-483b-ba3b-38b6f8bb1e48";
	
	@ResponseBody
	@RequestMapping(value = "/header", method = RequestMethod.GET)
	public Object findHeader() {
		String url = "http://localhost:8060/openapi/user/test";
		Map<String, Object> params = new HashMap<>();
		params.put("name", "abc");
		params.put("age", 18);
		params.put("sex", "man");
		return RestHelper.get(url, getSignHeader(params), JsonBean.class, params);
	}
	
	@ResponseBody
	@RequestMapping(value = "/param", method = RequestMethod.GET)
	public Object findParam() {
		String url = "http://localhost:8060/openapi/user/test";
		Map<String, Object> params = new HashMap<>();
		params.put("name", "abc");
		params.put("age", 18);
		params.put("sex", "man");
		return RestHelper.get(url, JsonBean.class, getSignParam(params));
	}
	
	@ResponseBody
	@RequestMapping(value = "/post", method = RequestMethod.GET)
	public Object findPost() {
		String url = "http://localhost:8060/openapi/user/post";
		OpenUserDO openUser = new OpenUserDO();
		openUser.setBrandId(123L);
		openUser.setBrandName("brand");
		return RestHelper.post(url, getSignHeader(), openUser, JsonBean.class);
	}
	
	//*************************************************
	
	private Map<String, Object> getSignHeader() {
		return getSignHeader(null);
	}
	
	private Map<String, Object> getSignHeader(Map<String, Object> params) {
		Long timestamp = DateUt.getTimeInMillis();
		String nonce = RandomUt.nextStr(NONCE_MAX);
		String sign = tokenHandler.signToken(token, privateKey, timestamp, nonce, params);
		Map<String, Object> header = new HashMap<>();
		header.put("token", token);
		header.put("timestamp", timestamp);
		header.put("sign", sign);
		header.put("nonce", nonce);
		return header;
	}
	
	private Map<String, Object> getSignParam(Map<String, Object> params) {
		Long timestamp = DateUt.getTimeInMillis();
		String nonce = RandomUt.nextStr(NONCE_MAX);
		String sign = tokenHandler.signToken(token, privateKey, timestamp, nonce, params);
		params.put("token", token);
		params.put("timestamp", timestamp);
		params.put("sign", sign);
		params.put("nonce", nonce);
		return params;
	}

}
